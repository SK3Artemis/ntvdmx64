/* Project: ldntvdm
 * Module : wow64inj
 * Author : leecher@dose.0wnz.at, Metasploit Framework
 * Descr. : This module implements functions for injecting DLLs into 64bit
 *          processes from WOW64 (32 bit) processes.
 * Changes: 01.04.2016  - Created
 */

#include "ldntvdm.h"
#if !defined(_WIN64) && defined(CREATEPROCESS_HOOK)

#ifdef NO_XOR
// see '/msf3/external/source/shellcode/x86/migrate/executex64.asm'
BYTE migrate_executex64[] = 
"\x55\x89\xE5\x56\x57\x8B\x75\x08\x8B\x4D\x0C\xE8\x00\x00\x00\x00"
"\x58\x83\xC0\x2A\x83\xEC\x08\x89\xE2\xC7\x42\x04\x33\x00\x00\x00"
"\x89\x02\xE8\x0E\x00\x00\x00\x66\x8C\xD8\x8E\xD0\x83\xC4\x14\x5F"
"\x5E\x5D\xC2\x08\x00\x8B\x3C\x24\xFF\x2A\x48\x31\xC0\x57\xFF\xD6"
"\x5F\x50\xC7\x44\x24\x04\x23\x00\x00\x00\x89\x3C\x24\xFF\x2C\x24";

// see '/msf3/external/source/shellcode/x64/migrate/remotethread.asm'
BYTE migrate_wownativex[] = 
"\xFC\x48\x89\xCE\x48\x89\xE7\x48\x83\xE4\xF0\xE8\xC8\x00\x00\x00"
"\x41\x51\x41\x50\x52\x51\x56\x48\x31\xD2\x65\x48\x8B\x52\x60\x48"
"\x8B\x52\x18\x48\x8B\x52\x20\x48\x8B\x72\x50\x48\x0F\xB7\x4A\x4A"
"\x4D\x31\xC9\x48\x31\xC0\xAC\x3C\x61\x7C\x02\x2C\x20\x41\xC1\xC9"
"\x0D\x41\x01\xC1\xE2\xED\x52\x41\x51\x48\x8B\x52\x20\x8B\x42\x3C"
"\x48\x01\xD0\x66\x81\x78\x18\x0B\x02\x75\x72\x8B\x80\x88\x00\x00"
"\x00\x48\x85\xC0\x74\x67\x48\x01\xD0\x50\x8B\x48\x18\x44\x8B\x40"
"\x20\x49\x01\xD0\xE3\x56\x48\xFF\xC9\x41\x8B\x34\x88\x48\x01\xD6"
"\x4D\x31\xC9\x48\x31\xC0\xAC\x41\xC1\xC9\x0D\x41\x01\xC1\x38\xE0"
"\x75\xF1\x4C\x03\x4C\x24\x08\x45\x39\xD1\x75\xD8\x58\x44\x8B\x40"
"\x24\x49\x01\xD0\x66\x41\x8B\x0C\x48\x44\x8B\x40\x1C\x49\x01\xD0"
"\x41\x8B\x04\x88\x48\x01\xD0\x41\x58\x41\x58\x5E\x59\x5A\x41\x58"
"\x41\x59\x41\x5A\x48\x83\xEC\x20\x41\x52\xFF\xE0\x58\x41\x59\x5A"
"\x48\x8B\x12\xE9\x4F\xFF\xFF\xFF\x5D\x4D\x31\xC9\x41\x51\x48\x8D"
"\x46\x18\x50\xFF\x76\x10\xFF\x76\x08\x41\x51\x41\x51\x49\xB8\x01"
"\x00\x00\x00\x00\x00\x00\x00\x48\x31\xD2\x48\x8B\x0E\x41\xBA\xC8"
"\x38\xA4\x40\xFF\xD5\x48\x85\xC0\x74\x0C\x48\xB8\x00\x00\x00\x00"
"\x00\x00\x00\x00\xEB\x0A\x48\xB8\x01\x00\x00\x00\x00\x00\x00\x00"
"\x48\x83\xC4\x50\x48\x89\xFC\xC3";

// see loadlibrary64.asm
BYTE ldr_load_library_x64[] =
"\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52"
"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"
"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"
"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"
"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"
"\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00"
"\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b"
"\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48"
"\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
"\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8"
"\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b"
"\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41"
"\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41"
"\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff"
"\x5d\x49\x89\xe1\x4c\x8d\x85\x14\x01\x00\x00\x49\x8d\x58\x08"
"\x53\x49\x8b\x18\x53\x49\x89\xe0\x48\x31\xc9\x48\x31\xd2\x41"
"\xba\x13\x9c\xbf\xbd\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6"
"\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb"
"\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
"\xd5";
#else
// XORed crap to evade false positive detection by M$ antivirus
BYTE migrate_executex64[] =
"\x00\xdc\xb0\x03\x02\xde\x20\x5d\xde\x18\x59\xbd\x55\x55\x55"
"\x55\x0d\xd6\x95\x7f\xd6\xb9\x5d\xdc\xb7\x92\x17\x51\x66\x55"
"\x55\x55\xdc\x57\xbd\x5b\x55\x55\x55\x33\xd9\x8d\xdb\x85\xd6"
"\x91\x41\x0a\x0b\x08\x97\x5d\x55\xde\x69\x71\xaa\x7f\x1d\x64"
"\x95\x02\xaa\x83\x0a\x05\x92\x11\x71\x51\x76\x55\x55\x55\xdc"
"\x69\x71\xaa\x79\x71";

BYTE migrate_wownativex[] =
"\xa9\x1d\xdc\x9b\x1d\xdc\xb2\x1d\xd6\xb1\xa5\xbd\x9d\x55\x55"
"\x55\x14\x04\x14\x05\x07\x04\x03\x1d\x64\x87\x30\x1d\xde\x07"
"\x35\x1d\xde\x07\x4d\x1d\xde\x07\x75\x1d\xde\x27\x05\x1d\x5a"
"\xe2\x1f\x1f\x18\x64\x9c\x1d\x64\x95\xf9\x69\x34\x29\x57\x79"
"\x75\x14\x94\x9c\x58\x14\x54\x94\xb7\xb8\x07\x14\x04\x1d\xde"
"\x07\x75\xde\x17\x69\x1d\x54\x85\x33\xd4\x2d\x4d\x5e\x57\x20"
"\x27\xde\xd5\xdd\x55\x55\x55\x1d\xd0\x95\x21\x32\x1d\x54\x85"
"\x05\xde\x1d\x4d\x11\xde\x15\x75\x1c\x54\x85\xb6\x03\x1d\xaa"
"\x9c\x14\xde\x61\xdd\x1d\x54\x83\x18\x64\x9c\x1d\x64\x95\xf9"
"\x14\x94\x9c\x58\x14\x54\x94\x6d\xb5\x20\xa4\x19\x56\x19\x71"
"\x5d\x10\x6c\x84\x20\x8d\x0d\x11\xde\x15\x71\x1c\x54\x85\x33"
"\x14\xde\x59\x1d\x11\xde\x15\x49\x1c\x54\x85\x14\xde\x51\xdd"
"\x1d\x54\x85\x14\x0d\x14\x0d\x0b\x0c\x0f\x14\x0d\x14\x0c\x14"
"\x0f\x1d\xd6\xb9\x75\x14\x07\xaa\xb5\x0d\x14\x0c\x0f\x1d\xde"
"\x47\xbc\x1a\xaa\xaa\xaa\x08\x18\x64\x9c\x14\x04\x1d\xd8\x13"
"\x4d\x05\xaa\x23\x45\xaa\x23\x5d\x14\x04\x14\x04\x1c\xed\x54"
"\x55\x55\x55\x55\x55\x55\x55\x1d\x64\x87\x1d\xde\x5b\x14\xef"
"\x9d\x6d\xf1\x15\xaa\x80\x1d\xd0\x95\x21\x59\x1d\xed\x55\x55"
"\x55\x55\x55\x55\x55\x55\xbe\x5f\x1d\xed\x54\x55\x55\x55\x55"
"\x55\x55\x55\x1d\xd6\x91\x05\x1d\xdc\xa9\x96";

BYTE ldr_load_library_x64[] =
"\xa9\x1d\xd6\xb1\xa5\xbd\x9d\x55\x55\x55\x14\x04\x14\x05\x07"
"\x04\x03\x1d\x64\x87\x30\x1d\xde\x07\x35\x1d\xde\x07\x4d\x1d"
"\xde\x07\x75\x1d\xde\x27\x05\x1d\x5a\xe2\x1f\x1f\x18\x64\x9c"
"\x1d\x64\x95\xf9\x69\x34\x29\x57\x79\x75\x14\x94\x9c\x58\x14"
"\x54\x94\xb7\xb8\x07\x14\x04\x1d\xde\x07\x75\xde\x17\x69\x1d"
"\x54\x85\x33\xd4\x2d\x4d\x5e\x57\x20\x27\xde\xd5\xdd\x55\x55"
"\x55\x1d\xd0\x95\x21\x32\x1d\x54\x85\x05\xde\x1d\x4d\x11\xde"
"\x15\x75\x1c\x54\x85\xb6\x03\x1d\xaa\x9c\x14\xde\x61\xdd\x1d"
"\x54\x83\x18\x64\x9c\x1d\x64\x95\xf9\x14\x94\x9c\x58\x14\x54"
"\x94\x6d\xb5\x20\xa4\x19\x56\x19\x71\x5d\x10\x6c\x84\x20\x8d"
"\x0d\x11\xde\x15\x71\x1c\x54\x85\x33\x14\xde\x59\x1d\x11\xde"
"\x15\x49\x1c\x54\x85\x14\xde\x51\xdd\x1d\x54\x85\x14\x0d\x14"
"\x0d\x0b\x0c\x0f\x14\x0d\x14\x0c\x14\x0f\x1d\xd6\xb9\x75\x14"
"\x07\xaa\xb5\x0d\x14\x0c\x0f\x1d\xde\x47\xbc\x1a\xaa\xaa\xaa"
"\x08\x1c\xdc\xb4\x19\xd8\xd0\x41\x54\x55\x55\x1c\xd8\x0d\x5d"
"\x06\x1c\xde\x4d\x06\x1c\xdc\xb5\x1d\x64\x9c\x1d\x64\x87\x14"
"\xef\x46\xc9\xea\xe8\xaa\x80\xee\xb5\x48\x7f\x5f\x14\xef\xf3"
"\xc0\xe8\xc8\xaa\x80\x1d\xd6\x91\x7d\x69\x53\x29\x5f\xd5\xae"
"\xb5\x20\x50\xee\x12\x46\x27\x3a\x3f\x55\x0c\x14\xdc\x8f\xaa"
"\x80";
#endif

typedef struct _WOW64CONTEXT
{
	union
	{
		HANDLE hProcess;
		BYTE bPadding2[8];
	} h;

	union
	{
		LPVOID lpStartAddress;
		BYTE bPadding1[8];
	} s;

	union
	{
		LPVOID lpParameter;
		BYTE bPadding2[8];
	} p;
	union
	{
		HANDLE hThread;
		BYTE bPadding2[8];
	} t;
} WOW64CONTEXT, *LPWOW64CONTEXT;

// Definitions used for running native x64 code from a wow64 process (see executex64.asm)
typedef BOOL(WINAPI * X64FUNCTION)(DWORD dwParameter);
typedef DWORD(WINAPI * EXECUTEX64)(X64FUNCTION pFunction, DWORD dwParameter);

void inject_dll_init()
{
#ifndef NO_XOR
	static BOOL bInizialized = FALSE;
	int i;

	if (bInizialized) return;
	for (i = 0; i < sizeof(migrate_executex64); i++) migrate_executex64[i] ^= 0x55;
	for (i = 0; i < sizeof(migrate_wownativex); i++) migrate_wownativex[i] ^= 0x55;
	for (i = 0; i < sizeof(ldr_load_library_x64); i++) ldr_load_library_x64[i] ^= 0x55;
	bInizialized = TRUE;
#endif
}


/*
* Attempt to gain code execution in a native x64 process from a wow64 process by transitioning out of the wow64 (x86)
* enviroment into a native x64 enviroment and accessing the native win64 APIs.
*/
DWORD inject_via_remotethread_wow64(HANDLE hProcess, LPVOID lpStartAddress, LPVOID lpParameter, HANDLE * pThread)
{
	DWORD dwResult = ERROR_SUCCESS;
	EXECUTEX64 pExecuteX64 = NULL;
	X64FUNCTION pX64function = NULL;
	WOW64CONTEXT * ctx = NULL;

	inject_dll_init();
	// alloc a RWX buffer in this process for the EXECUTEX64 function
	if (pExecuteX64 = (EXECUTEX64)VirtualAlloc(NULL, sizeof(migrate_executex64), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE))
	{
		RtlMoveMemory(pExecuteX64, &migrate_executex64, sizeof(migrate_executex64));
		if (pX64function = (X64FUNCTION)VirtualAlloc(NULL, sizeof(migrate_wownativex) + sizeof(WOW64CONTEXT), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE))
		{
			RtlMoveMemory(pX64function, &migrate_wownativex, sizeof(migrate_wownativex));
			ctx = (WOW64CONTEXT *)((BYTE *)pX64function + sizeof(migrate_wownativex));
			ctx->h.hProcess = hProcess;
			ctx->s.lpStartAddress = lpStartAddress;
			ctx->p.lpParameter = lpParameter;
			ctx->t.hThread = NULL;

			// Transition this wow64 process into native x64 and call pX64function( ctx )
			// The native function will use the native Win64 API's to create a remote thread in the target process.
			if (!pExecuteX64(pX64function, (DWORD)ctx))
				SetLastError(dwResult = ERROR_ACCESS_DENIED);
			else
			if (!ctx->t.hThread)
				SetLastError(dwResult = ERROR_INVALID_HANDLE);
			else
				*pThread = ctx->t.hThread;
		}
	}

	if (pExecuteX64)
		VirtualFree(pExecuteX64, 0, MEM_DECOMMIT);

	if (pX64function)
		VirtualFree(pX64function, 0, MEM_DECOMMIT);

	return dwResult;
}

BOOL inject_dll_x64(HANDLE hProcess, WCHAR *wszDLL) 
{

	// classic VAE-WPM-CRT
	UNICODE_STRING uStr;
	LPBYTE lpRemoteLibraryBuffer;
	HANDLE hThread;

	inject_dll_init();
	uStr.Length = uStr.MaximumLength = (USHORT)lstrlenW(wszDLL)*sizeof(WCHAR);
	uStr.Buffer = NULL;
	if (!(lpRemoteLibraryBuffer = VirtualAllocEx(hProcess, NULL, sizeof(ldr_load_library_x64) - 1 + uStr.Length + sizeof(UNICODE_STRING), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE)) ||
		!WriteProcessMemory(hProcess, lpRemoteLibraryBuffer, ldr_load_library_x64, sizeof(ldr_load_library_x64) - 1, NULL) ||
		!WriteProcessMemory(hProcess, lpRemoteLibraryBuffer + sizeof(ldr_load_library_x64) - 1, &uStr, sizeof(uStr), NULL) ||
		!WriteProcessMemory(hProcess, lpRemoteLibraryBuffer + sizeof(ldr_load_library_x64) - 1 + 8, wszDLL, uStr.Length, NULL))
	{
		OutputDebugStringA("Copy loader code to target process faied.");
		return FALSE;
	}
	// First we try to inject by directly creating a remote thread in the target process
	if ((inject_via_remotethread_wow64(hProcess, lpRemoteLibraryBuffer, NULL, &hThread)) != ERROR_SUCCESS)
	{
		OutputDebugStringA("inject_via_remotethread failed");
		return FALSE;
	}
	else
	{
		ResumeThread(hThread);
		CloseHandle(hThread);
	}
	return TRUE;
}


#endif